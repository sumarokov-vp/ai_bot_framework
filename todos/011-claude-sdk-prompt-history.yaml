title: "Ревью ClaudeSdkProvider._build_prompt() — потеря истории"
status: done
created_at: 13.02.2026
completed_at: 13.02.2026

todoist:
  task_id: "6g29F93frj7h2hJr"

description: |
  ClaudeSdkProvider._build_prompt() берёт только последнее сообщение
  пользователя, игнорируя всю историю переписки. Контекст теряется.

recommendation: |
  Проверить, намеренно ли это (ограничение Claude Code SDK — session resumption
  может хранить историю на стороне SDK). Если нет — передавать полную историю.

solution: |
  claude-code-sdk query() принимает prompt: str, а не список сообщений.
  При возобновлении сессии (resume=session_id) SDK хранит историю на своей стороне,
  поэтому достаточно последнего сообщения. Но при первом вызове (session_id=None)
  вся предыдущая история терялась — отправлялось только последнее user-сообщение.
  Исправлено: при отсутствии session_id _build_prompt() конкатенирует все сообщения
  в формате [User]/[Assistant] в единый prompt. При наличии session_id — только
  последнее user-сообщение (SDK уже знает контекст).
